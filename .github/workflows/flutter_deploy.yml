name: Deploy to Google Play (Internal Track)

on:
  push:
    branches:
      - master
  workflow_dispatch:

# Cancel any in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build & Deploy AAB
    runs-on: ubuntu-latest

    env:
      # Offset to ensure version codes exceed any previously uploaded ones.
      # Setting to 3 to start from version code 4, 5, 6, etc.
      VERSION_CODE_OFFSET: 3
      # Major.Minor prefix for versionName (versionName = VERSION_PREFIX.BUILD_NUMBER)
      VERSION_PREFIX: '1.0'

    steps:
      # ════════════════════════════════════════════════════════════════════════════════
      # 1. Checkout the repository
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Checkout repository
        uses: actions/checkout@v4

      # ════════════════════════════════════════════════════════════════════════════════
      # 2. Set up Java (required for Android/Gradle)
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ════════════════════════════════════════════════════════════════════════════════
      # 3. Install Flutter SDK with caching
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      # ════════════════════════════════════════════════════════════════════════════════
      # 4. Cache Pub dependencies
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool/
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      # ════════════════════════════════════════════════════════════════════════════════
      # 5. Cache Gradle dependencies
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/build.gradle.kts', 'android/app/build.gradle.kts') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ════════════════════════════════════════════════════════════════════════════════
      # 6. Install dependencies
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Install dependencies
        run: flutter pub get

      # ════════════════════════════════════════════════════════════════════════════════
      # 7. Decode the Android Keystore from secrets
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Decode Android Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          echo "Keystore decoded successfully"
          ls -la android/app/upload-keystore.jks

      # ════════════════════════════════════════════════════════════════════════════════
      # 8. Create key.properties file
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Create key.properties
        run: |
          cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF
          echo "key.properties created successfully"

      # ════════════════════════════════════════════════════════════════════════════════
      # 9. Build Release AAB
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Compute Version
        id: version
        env:
          OFFSET: ${{ env.VERSION_CODE_OFFSET }}
          RUN_NUM: ${{ github.run_number }}
          PREFIX: ${{ env.VERSION_PREFIX }}
        run: |
          # Use shell arithmetic with defaults
          OFFSET=${OFFSET:-10}
          RUN_NUM=${RUN_NUM:-1}
          PREFIX=${PREFIX:-1.0}

          echo "DEBUG: OFFSET='$OFFSET', RUN_NUM='$RUN_NUM', PREFIX='$PREFIX'"

          BUILD_NUMBER=$(( RUN_NUM + OFFSET ))
          VERSION_NAME="${PREFIX}.${BUILD_NUMBER}"

          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT

          echo "Computed versionCode: $BUILD_NUMBER (Run: $RUN_NUM + Offset: $OFFSET)"
          echo "Computed versionName: $VERSION_NAME"

      - name: Build Release AAB
        run: |
          echo "Building AAB — versionCode=${{ steps.version.outputs.BUILD_NUMBER }}, versionName=${{ steps.version.outputs.VERSION_NAME }}"
          flutter build appbundle --release \
            --build-number=${{ steps.version.outputs.BUILD_NUMBER }} \
            --build-name=${{ steps.version.outputs.VERSION_NAME }}

      # ════════════════════════════════════════════════════════════════════════════════
      # 10. Upload AAB as build artifact (for debugging)
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab-v${{ steps.version.outputs.VERSION_NAME }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      # ════════════════════════════════════════════════════════════════════════════════
      # 11. Deploy to Google Play Internal Track
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Deploy to Google Play (Internal Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.karna.chessmaster
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          whatsNewDirectory: distribution/whatsnew
        continue-on-error: false

      # ════════════════════════════════════════════════════════════════════════════════
      # 12. Post-deploy summary
      # ════════════════════════════════════════════════════════════════════════════════
      - name: Deployment Summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **App** | ChessMaster Offline |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | com.karna.chessmaster |" >> $GITHUB_STEP_SUMMARY
          echo "| **Track** | Internal Testing |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Name** | ${{ steps.version.outputs.VERSION_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Code** | ${{ steps.version.outputs.BUILD_NUMBER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
