name: Deploy to Google Play (Internal Track)

on:
  push:
    branches:
      - master
  workflow_dispatch:

# Cancel any in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build & Deploy AAB
    runs-on: ubuntu-latest

    env:
      # Using timestamp-based versioning for uniqueness
      TIMESTAMP_VERSION: true
    
    steps:
      # ───────────────────────────────────────────────
      # 1. Checkout the repository
      # ───────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ───────────────────────────────────────────────
      # 2. Set up Java (required for Android/Gradle)
      # ───────────────────────────────────────────────
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ───────────────────────────────────────────────
      # 3. Install Flutter SDK with caching
      # ───────────────────────────────────────────────
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      # ───────────────────────────────────────────────
      # 4. Cache Pub dependencies
      # ───────────────────────────────────────────────
      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool/
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      # ───────────────────────────────────────────────
      # 5. Cache Gradle dependencies
      # ───────────────────────────────────────────────
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/build.gradle.kts', 'android/app/build.gradle.kts') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ───────────────────────────────────────────────
      # 6. Install dependencies
      # ───────────────────────────────────────────────
      - name: Install dependencies
        run: flutter pub get

      # ───────────────────────────────────────────────
      # 7. Decode the Android Keystore from secrets
      # ───────────────────────────────────────────────
      - name: Decode Android Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks
          echo "Keystore decoded successfully"
          ls -la android/app/keystore.jks

      # ───────────────────────────────────────────────
      # 8. Compute Version (Timestamp + Run Number)
      # ───────────────────────────────────────────────
      - name: Compute Version
        id: version
        env:
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          # Use Unix timestamp for integer versionCode (always increases, no collisions)
          BUILD_NUMBER=$(date +%s)
          
          # Use 1.3.RUN_NUMBER for readable, incremental versionName
          # Example: 1.3.5, 1.3.6, etc.
          VERSION_NAME="1.3.${RUN_NUMBER}"
          
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          
          echo "Computed versionCode: $BUILD_NUMBER (Unix Timestamp)"
          echo "Computed versionName: $VERSION_NAME"

      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEYSTORE_FILE: app/keystore.jks
        run: |
          echo "Building AAB — versionCode=${{ steps.version.outputs.BUILD_NUMBER }}, versionName=${{ steps.version.outputs.VERSION_NAME }}"
          flutter build appbundle --release \
            --build-number=${{ steps.version.outputs.BUILD_NUMBER }} \
            --build-name=${{ steps.version.outputs.VERSION_NAME }}

      # ───────────────────────────────────────────────
      # 9. Upload AAB as build artifact (for debugging)
      # ───────────────────────────────────────────────
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab-v${{ steps.version.outputs.VERSION_NAME }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      # ───────────────────────────────────────────────
      # 10. Deploy to Google Play Internal Track
      # ───────────────────────────────────────────────
      - name: Deploy to Google Play (Internal Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.karna.chessmaster
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          whatsNewDirectory: distribution/whatsnew
        continue-on-error: false

      # ───────────────────────────────────────────────
      # 11. Post-deploy summary
      # ───────────────────────────────────────────────
      - name: Deployment Summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **App** | ChessMaster Offline |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | com.karna.chessmaster |" >> $GITHUB_STEP_SUMMARY
          echo "| **Track** | Internal Testing |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Name** | ${{ steps.version.outputs.VERSION_NAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Code** | ${{ steps.version.outputs.BUILD_NUMBER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
